#include "oled.h"

static struct i2c_client *oled_client;

static const unsigned char logo[]={
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x70,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0xe0,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,
	0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x03,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x80,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x11,0x80,
	0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x11,0x80,0x07,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x1b,0x80,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x80,0x1b,0x80,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x3b,0xc0,
	0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x3b,0xc0,0x07,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x80,0x3b,0xc0,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x80,0x3f,0xc0,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x77,0xe0,
	0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x77,0xe0,0x03,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0xc0,0x77,0xf0,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0xc0,0x7f,0xf0,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xe0,0x6f,0xf0,
	0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xe0,0xef,0xf8,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0xe0,0xef,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0xe0,0xff,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xf0,0xdf,0x7c,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf0,0xdf,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x40,0xf0,0xdf,0x3f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x40,0xf0,0xdf,0x3f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0xf8,0xbf,0x1f,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x38,0xff,0x1f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x20,0x38,0xff,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x10,0x38,0xff,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x3c,0xff,0x07,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x3c,0xfe,0x07,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x18,0x1c,0xfe,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x18,0x1c,0xfe,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x1e,0xff,0x07,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x9e,0xff,0x06,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x1c,0xce,0xff,0x0e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x3c,0xee,0xff,0x0e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7c,0xfe,0xff,0x0f,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfc,0xff,0xff,0x0d,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0xfc,0xff,0xff,0x1d,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0xfc,0xff,0xff,0x1d,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfc,0xff,0xfb,0x1f,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf8,0xff,0xf8,0x1b,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0xf8,0x7f,0xf8,0x3b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0xf8,0x3f,0xf0,0x3b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf0,0x0f,0xf0,0x3f,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x03,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,
	0x00,0x00,0x00,0x30,0x08,0x00,0x00,0x00,0x00,0x30,0xf8,0xf0,0x18,0xf1,0xf1,0x31,
	0x8c,0x08,0xf1,0x00,0x00,0x78,0x88,0x88,0x08,0x11,0x10,0x31,0xc6,0x98,0x99,0x01,
	0x00,0x68,0x88,0x88,0x08,0x11,0x18,0x71,0x45,0x9c,0x08,0x01,0x00,0x64,0xf8,0x0c,
	0xf8,0x71,0xf8,0xd9,0x45,0xb4,0x08,0x01,0x00,0x7e,0x2c,0x84,0x8c,0x08,0x68,0xc8,
	0x46,0xe4,0x88,0x01,0x00,0x42,0x64,0xcc,0x84,0x98,0x48,0x48,0x66,0xe4,0xcc,0x00,
	0x00,0xc1,0x44,0x7c,0x84,0xf8,0xcc,0x08,0x62,0x46,0x7c,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	
};
static struct mutex mutex;
int line;

extern void temperature_test(char *buf);

int oled_write(u8 reg, u8 data)
{
    struct i2c_msg msg;
    struct i2c_client *cli = oled_client;
	int ret = 0;
    u8 buf[2] = {reg, data};
    msg.addr = cli->addr;
    msg.flags = 0;
    msg.len = 2;
    msg.buf = buf;
	ret = i2c_transfer(cli->adapter, &msg, 1);
	printk("shao, func = %s, i2c_transfer(cli->adapter, &msg, 1) = %d\n", __func__,ret);
    if (ret!= 1)
    {
		printk("shao, write failed ...\n");
		return -1;	
	}    
	return 0;
}

u8 oled_read(u8 reg)
{
    struct i2c_client *cli = oled_client;
    struct i2c_msg msg[2];

    u8 tmp;
    memset(msg, 0, sizeof(msg));
    msg[0].addr = cli->addr;
    msg[0].len = 1;
    msg[0].buf = &reg;
    msg[1].addr = cli->addr;
    msg[1].len = 1;
    msg[1].flags = I2C_M_RD;
    msg[1].buf = &tmp;
    if (i2c_transfer(cli->adapter, msg, 2) != 2)
	{
		printk("read failed ...\n");
	}
        
    return tmp;
}
static ssize_t oled_store_show_string(struct device *dev, struct device_attribute *attr,
				const char *buf, size_t count)
{
	mutex_lock(&mutex);
	/* struct oled_context *devobj = (struct oled_context*)dev_get_drvdata(dev); */
	/* do read FIFO data function and report data immediately */
	setTextXY(line,0);
	putString(buf);
	line++;
	line %= 12;
	mutex_unlock(&mutex);
	return count;
}

static ssize_t oled_store_clear(struct device *dev, struct device_attribute *attr,
				const char *buf, size_t count)
{
	mutex_lock(&mutex);
	/* struct oled_context *devobj = (struct oled_context*)dev_get_drvdata(dev); */
	/* do read FIFO data function and report data immediately */
	line = 0; 
	setNormalDisplay(); //Set Normal Display Mode
  setVerticalMode();
	clearDisplay(); 
 
	mutex_unlock(&mutex);
	return count;
}

static ssize_t oled_store_show_logo(struct device *dev, struct device_attribute *attr,
				const char *buf, size_t count)
{
	mutex_lock(&mutex);
	/* struct oled_context *devobj = (struct oled_context*)dev_get_drvdata(dev); */
	/* do read FIFO data function and report data immediately */
	setInverseDisplay();             // Set Display to inverse mode  
  clearDisplay();                  //  clear the screen and set start position to top left corner
  drawBitmap(logo,96*96/8);   // (96 pixels *96 pixels  / 8) bytes   
  setNormalDisplay(); 
  setVerticalMode();
	mutex_unlock(&mutex);
	return count;
}
DEVICE_ATTR(show_string, S_IWUSR | S_IRUGO, NULL, oled_store_show_string);
DEVICE_ATTR(clear, S_IWUSR | S_IRUGO, NULL, oled_store_clear);
DEVICE_ATTR(show_logo, S_IWUSR | S_IRUGO, NULL, oled_store_show_logo);

static struct attribute *oled_attributes[] = {
	&dev_attr_show_string.attr,
	&dev_attr_clear.attr,
	&dev_attr_show_logo.attr,
	NULL
};

static struct attribute_group oled_attribute_group = {
	.attrs = oled_attributes
};

static int oled_i2c_probe(struct i2c_client *client,
		const struct i2c_device_id *id)
{
	printk("shao, func = %s, i2c probe in\n", __func__);
	int err;
#ifdef CONFIG_CUSTOM_FEATURE_TEMP
	char buf[12] = {0};
#endif	
	oled_client = client;
	line = 0;
	mutex_init(&mutex);
	err = sysfs_create_group(&client->dev.kobj, &oled_attribute_group);
	  printk("shao, sysfs_create_group, err = %d\n",err);
  err = init();  //initialize SEEED OLED display
  printk("shao, func = %s, err = %d\n", __func__,err);
  if(err != 0)
  {
	return -1;  
  }

  clearDisplay();     //Clear Display.
  setNormalDisplay(); //Set Normal Display Mode
  setVerticalMode();  // Set to vertical mode for displaying text

  
  setInverseDisplay(); 
	drawBitmap(logo,96*96/8);
	setNormalDisplay(); //Set Normal Display Mode
  setVerticalMode();
#ifdef CONFIG_CUSTOM_FEATURE_TEMP
  temperature_test(buf);
  pr_err("====dyong====buf=%s\n",buf);
  setTextXY(11,0);
	putString(buf);
#endif
	return 0;
}

static void oled_i2c_shutdown(struct i2c_client *client)
{
}

/** remove oled i2c client <!-- {{{1 -->
 * @param client the pointer of i2c client
 * @return always zero
 */
static int oled_i2c_remove(struct i2c_client *client)
{
    return 0;
}

static const struct i2c_device_id oled_id[] = {
      {"feature_oled"},
    	{ }
};

#ifdef CONFIG_OF
static struct of_device_id feature_oled_match_table[] = {
	    { .compatible = "grove,oled", },
	    { },
};
#else
#define feature_oled_match_table NULL
#endif

static struct i2c_driver oled_i2c_driver = {
    .driver = {
        .owner = THIS_MODULE,
        .name  = "feature_oled",
        .of_match_table = feature_oled_match_table,
    },
    .id_table   = oled_id,
    .probe      = oled_i2c_probe,
    .shutdown   = oled_i2c_shutdown,
    .remove     = oled_i2c_remove
};

static int __init oled_init(void)
{
	if (i2c_add_driver(&oled_i2c_driver)) {
		return -1;
	}
	return 0;
}
static void __exit oled_exit(void)
{
    i2c_del_driver(&oled_i2c_driver);
}
module_init(oled_init);
module_exit(oled_exit);

MODULE_DESCRIPTION("ARCHERMIND OLED FEATURE");
MODULE_LICENSE("GPL");
